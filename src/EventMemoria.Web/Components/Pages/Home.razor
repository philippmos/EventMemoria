@page "/upload"

@using EventMemoria.Web.Common.Constants
@using EventMemoria.Web.Components.NameModal
@using EventMemoria.Web.Components.Photo
@using Microsoft.FeatureManagement

@rendermode InteractiveServer

<CustomPageTitle Value="Galerie" />

<NameModal OnNameSaved="@OnNameSaved" />

<HeaderComponent />

<UploadComponent @ref="_uploadComponent"
                        OnPhotosUploaded="@RefreshVirtualizedGridAsync" />

<VirtualizedGrid @ref="_virtualizedGrid"
                        OnPhotosLoaded="@OnPhotosLoaded"
                        ShowGridControls="true" />

@code {
    [Inject] private IFeatureManager FeatureManager { get; set; } = null!;
    [Inject] private NavigationManager NavigationManager { get; set; } = null!;

    private VirtualizedGrid? _virtualizedGrid;
    private UploadComponent? _uploadComponent;

    protected override async Task OnInitializedAsync()
    {
        if (!await FeatureManager.IsEnabledAsync(FeatureFlags.EnableUploadPage))
        {
            return;
        }
    }

    private async Task RefreshVirtualizedGridAsync()
    {
        if (_virtualizedGrid != null)
        {
            await _virtualizedGrid.RefreshPhotosAsync();
        }

        await InvokeAsync(StateHasChanged);
    }

    private void OnPhotosLoaded(List<Photo> photos)
    {
        StateHasChanged();
    }

    private async Task OnNameSaved()
    {
        if (_uploadComponent != null)
        {
            await _uploadComponent.RefreshUserNameAsync();
        }
    }
}
