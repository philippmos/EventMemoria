@using EventMemoria.Web.Common.Constants
@using EventMemoria.Web.Common.Settings
@using Microsoft.Extensions.Options
@using Microsoft.FeatureManagement

@if (!string.IsNullOrWhiteSpace(DownloadLink))
{
    <MudButton Variant="MudBlazor.Variant.Filled"
               Color="Color.Default"
               Size="Size.Small"
               StartIcon="@Icons.Material.Filled.Download"
               Class="mt-5"
               FullWidth="true"
               OnClick="DownloadArchiveAsync">
        <MudText>Alle herunterladen</MudText>
    </MudButton>
}


@code {
    [Inject] private IFeatureManager FeatureManager { get; set; } = null!;
    [Inject] private IOptions<PhotoOptions> PhotoOptions { get; set; } = null!;
    [Inject] private IOptions<CustomizationOptions> CustomizationOptions { get; set; } = null!;
    [Inject] private IJSRuntime JsRuntime { get; set; } = null!;
    [Inject] private ISnackbar Snackbar { get; set; } = null!;
    [Inject] private ILogger<GalleryDownloadAllButton> Logger { get; set; } = null!;

    private string DownloadLink = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        if (!await FeatureManager.IsEnabledAsync(FeatureFlags.EnablePhotoDownload))
        {
            return;
        }

        DownloadLink = PhotoOptions.Value.AllPhotosDownloadArchive;
    }

    private async Task DownloadArchiveAsync()
    {
        if (string.IsNullOrWhiteSpace(DownloadLink))
        {
            return;
        }

        var fileName = GetDownloadFileName();

        try
        {
            await JsRuntime.InvokeVoidAsync("FileDownloader.downloadFile", DownloadLink, fileName);
            Snackbar.Add("Download gestartet.", Severity.Success);
            Logger.LogInformation("Photo archive download initiated from URL: {Url}", DownloadLink);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initiate photo archive download from URL: {Url}", DownloadLink);
            Snackbar.Add("Download konnte nicht gestartet werden.", Severity.Warning);
        }
    }

    private string GetDownloadFileName()
    {
        var eventTitle = CustomizationOptions.Value.Title;
        if (!string.IsNullOrWhiteSpace(eventTitle))
        {
            var invalidChars = Path.GetInvalidFileNameChars();
            var sanitizedTitle = new string(eventTitle.Select(c => invalidChars.Contains(c) ? '_' : c).ToArray());
            return $"{sanitizedTitle}_photos.zip";
        }
        return "photos.zip";
    }
}
