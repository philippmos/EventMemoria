@using EventMemoria.Web.Common.Constants
@using EventMemoria.Web.Helpers
@using EventMemoria.Web.Services.Interfaces
@using Microsoft.FeatureManagement
@using Microsoft.JSInterop

@inject IJSRuntime JSRuntime

<MudContainer MaxWidth="MaxWidth.False" Class="pa-0">
    <MudStack Spacing="2" Class="pa-2">
        <MudPaper Class="pa-3" Elevation="1">
            <div class="d-flex flex-column">
                <MudHidden Breakpoint="Breakpoint.SmAndDown">
                    <div class="grid-controls-container" @ref="_containerRef">
                        <MudChipSet T="string"
                                    SelectedValue="@_selectedSubItem"
                                    SelectedValueChanged="@OnChipSelectedAsync"
                                    Class="grid-controls-chipset">

                            @foreach (var (subfolder, index) in _subfolders.Select((s, i) => (s, i)))
                            {
                                <MudChip T="string"
                                         Value="@subfolder"
                                         Color="Color.Default"
                                         Variant="MudBlazor.Variant.Filled"
                                         Size="Size.Medium"
                                         id="@($"chip-{index}")"
                                         Class="grid-controls-chip">
                                    @subfolder
                                </MudChip>
                            }
                        </MudChipSet>
                    </div>
                </MudHidden>

                <MudHidden Breakpoint="Breakpoint.MdAndUp">
                    <MudSelect T="string"
                               Value="@_selectedSubItem"
                               ValueChanged="@OnChipSelectedAsync"
                               Label="Album auswÃ¤hlen"
                               Variant="MudBlazor.Variant.Outlined"
                               AnchorOrigin="Origin.BottomCenter"
                               FullWidth="true"
                               Class="gallery-mobile-select">
                        @foreach (var subfolder in _subfolders)
                        {
                            <MudSelectItem T="string" Value="@subfolder">@subfolder</MudSelectItem>
                        }
                    </MudSelect>
                </MudHidden>
            </div>

            <GalleryDownloadAllButton />

        </MudPaper>
    </MudStack>
</MudContainer>



@code {
    [Parameter] public EventCallback<string> OnSubFolderChanged { get; set; }

    [Inject] private IStorageService StorageService { get; set; } = null!;

    private List<string> _subfolders = new();
    private string? _selectedSubItem;
    private ElementReference _containerRef;

    protected override async Task OnInitializedAsync()
    {
        _subfolders = (await StorageService.GetGallerySubFoldersAsync()).ToList();
        _selectedSubItem ??= _subfolders.FirstOrDefault();

        await OnSubFolderChanged.InvokeAsync(_selectedSubItem);
    }

    private async Task OnChipSelectedAsync(string value)
    {
        _selectedSubItem = value;
        var index = _subfolders.IndexOf(value);
        
        if (index >= 0)
        {
            await JSRuntime.InvokeVoidAsync("scrollToChip", _containerRef, $"chip-{index}");
        }

        await OnSubFolderChanged.InvokeAsync(value);
    }
}
