@page "/"
@using Vogelhochzeit.Components.Shared
@using Vogelhochzeit.Models
@inject IWebHostEnvironment WebHostEnvironment
@rendermode InteractiveServer

<PageTitle>Vogelhochzeit - Fotoportal</PageTitle>

<div class="birds-container">
    <HeaderComponent Title="Vogelhochzeit" 
                     Names="Jasmin & Philipp" 
                     AvatarImagePath="/title-image.jpg"
                     WelcomeMessage="Schön, dass ihr alle da seid! Lasst uns gemeinsam unvergessliche Erinnerungen schaffen ❤️❤️❤️" />

    <PhotoGridComponent Photos="@allPhotos.ToList()" 
                        OnPhotosUploaded="@RefreshPhotos" />
</div>

@code {
    private List<Photo> allPhotos = [];

    protected override void OnInitialized()
    {
        LoadPhotosFromUploads();
    }

    private async Task RefreshPhotos()
    {
        LoadPhotosFromUploads();
        await InvokeAsync(StateHasChanged);
    }

    private void LoadPhotosFromUploads()
    {
        var uploadsPath = Path.Combine(WebHostEnvironment.WebRootPath, "uploads");
        
        var supportedExtensions = new[] { ".jpg", ".jpeg", ".png", ".gif", ".bmp", ".webp" };
        var imageFiles = Directory.GetFiles(uploadsPath)
            .Where(file => supportedExtensions.Contains(Path.GetExtension(file).ToLowerInvariant()))
            .ToArray();

        allPhotos = imageFiles.Select(file => 
        {
            var fileName = Path.GetFileName(file);
            var webPath = $"/uploads/{fileName}";
            return new Photo(Guid.NewGuid(), webPath);
        }).ToList();
    }
}
